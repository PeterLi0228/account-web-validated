"use client"

import { useState, useEffect, useRef, useCallback } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Send, Bot, User, BookOpen, Plus, Edit3, Eye, Lock, Settings2, LayoutList, Edit } from "lucide-react"
import { useRouter } from "next/navigation"
import AppLayout from "../components/AppLayout"
import { useAuth } from "@/contexts/AuthContext"
import { useBills } from "@/contexts/BillContext"
import { supabase } from "@/lib/supabase"
import type { Bill, Transaction, Category, AILog } from "@/types"

interface Message {
  id: string
  type: "user" | "ai"
  content: string
  timestamp: Date
  suggestedRecord?: TransactionData
  isProcessing?: boolean
  linkedTransactionId?: string // ÂÖ≥ËÅîÁöÑ‰∫§ÊòìËÆ∞ÂΩïID
}

interface TransactionData {
  type: "income" | "expense"
  date: string
  item: string
  amount: number
  person: string
  note: string
  category_id: string
}

export default function ChatPage() {
  const router = useRouter()
  const { user } = useAuth()
  const { bills, currentBillId, setCurrentBillId, addTransaction, fetchBills } = useBills()
  
  const [messages, setMessages] = useState<Message[]>([])
  const [inputValue, setInputValue] = useState("")
  const [isAISending, setIsAISending] = useState(false)
  const [isLoadingHistory, setIsLoadingHistory] = useState(false)
  const [showConfirmModal, setShowConfirmModal] = useState(false)
  const [suggestedRecord, setSuggestedRecord] = useState<TransactionData | null>(null)
  const [selectedBillId, setSelectedBillId] = useState<string>("")
  const [isConfirming, setIsConfirming] = useState(false)
  const [showEditModal, setShowEditModal] = useState(false)
  const [editingTransaction, setEditingTransaction] = useState<Transaction | null>(null)
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const scrollAreaRef = useRef<any>(null)

  // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑË¥¶Êú¨
  const currentBill = bills.find(bill => bill.id === selectedBillId)

  // ÊªöÂä®Âà∞Â∫ïÈÉ®ÁöÑÂáΩÊï∞
  const scrollToBottom = useCallback(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: "smooth" })
    }
    // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•Êìç‰ΩúScrollArea
    if (scrollAreaRef.current) {
      const scrollElement = scrollAreaRef.current.querySelector('[data-radix-scroll-area-viewport]')
      if (scrollElement) {
        scrollElement.scrollTop = scrollElement.scrollHeight
      }
    }
  }, [])

  // ÂàùÂßãÂåñÈÄâÊã©ÊúÄËøëÁöÑË¥¶Êú¨
  useEffect(() => {
    if (bills.length > 0 && !selectedBillId) {
      // ‰ºòÂÖàÈÄâÊã©ÈªòËÆ§Ë¥¶Êú¨
      const defaultBill = bills.find(bill => bill.is_default)
      const billToSelect = defaultBill || bills.sort((a, b) => 
        new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
      )[0]
      setSelectedBillId(billToSelect.id)
    }
  }, [bills, selectedBillId])

  // Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤
  const loadChatHistory = useCallback(async () => {
    if (!selectedBillId || !user) return

    setIsLoadingHistory(true)
    try {
      const { data: aiLogs, error } = await supabase
        .from('ai_logs')
        .select('*')
        .eq('bill_id', selectedBillId)
        .order('created_at', { ascending: false })
        .limit(15)

      if (error) {
        console.error('Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error.message || error)
        return
      }

      if (aiLogs && aiLogs.length > 0) {
        const historyMessages: Message[] = aiLogs
          .reverse() // ÂèçËΩ¨È°∫Â∫èÔºåËÆ©ÊúÄÊñ∞ÁöÑÂú®Â∫ïÈÉ®
          .map((log: any) => ({
          id: log.id,
          type: log.role === 'user' ? 'user' : 'ai',
          content: log.content,
            timestamp: new Date(log.created_at),
            linkedTransactionId: log.linked_transaction_id
        }))

        setMessages(historyMessages)
      } else {
        setMessages([])
      }
    } catch (error) {
      console.error('Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤ÂºÇÂ∏∏:', error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ')
    } finally {
      setIsLoadingHistory(false)
    }
  }, [selectedBillId, user])

  useEffect(() => {
    if (!user) {
      router.push('/login')
      return
    }
  }, [user, router])

  // ÂΩìÈÄâÊã©ÁöÑË¥¶Êú¨ÊîπÂèòÊó∂ÔºåÂä†ËΩΩËÅäÂ§©ÂéÜÂè≤
  useEffect(() => {
    if (selectedBillId && user) {
      loadChatHistory()
    }
  }, [selectedBillId, user, loadChatHistory])

  // Á°Æ‰øùÂú®Ê∂àÊÅØÊõ¥Êñ∞ÂêéÊªöÂä®Âà∞Â∫ïÈÉ®
  useEffect(() => {
    if (!isLoadingHistory) {
      // ‰ΩøÁî®requestAnimationFrameÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
      requestAnimationFrame(() => {
        setTimeout(scrollToBottom, 50)
      })
    }
  }, [messages, isLoadingHistory, scrollToBottom])

  const canEdit = currentBill?.permission === "owner" || currentBill?.permission === "edit_add" || currentBill?.permission === "add_only"



  const handleSendMessage = async () => {
    if (!inputValue.trim() || !canEdit || !currentBill || !user) return

    const userMessage: Message = {
      id: Date.now().toString(),
      type: "user",
      content: inputValue,
      timestamp: new Date(),
    }
    setMessages((prev: Message[]) => [...prev, userMessage])
    
    const currentInput = inputValue;
    setInputValue("")
    setIsAISending(true)

    // ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
    const { saveAILog } = await import('@/lib/ai')
    await saveAILog(currentBill.id, user.id, 'user', currentInput)

    // Ê∑ªÂä†Â§ÑÁêÜ‰∏≠Ê∂àÊÅØ
    setMessages((prev: Message[]) => [...prev, {id: "ai-processing", type: "ai", content: "Ê≠£Âú®ÊÄùËÄÉ‰∏≠...", timestamp: new Date(), isProcessing: true}])

    try {
      // Ë∞ÉÁî®AIÊúçÂä°
      const { sendChatMessage } = await import('@/lib/ai')
      const chatHistory = messages.slice(-5).map(msg => ({
        role: msg.type === 'user' ? 'user' as const : 'assistant' as const,
        content: msg.content
      }))
      
      const aiResponse = await sendChatMessage([
        ...chatHistory,
        { role: 'user', content: currentInput }
      ], currentBill?.categories)

      // ÁßªÈô§Â§ÑÁêÜ‰∏≠Ê∂àÊÅØ
      setMessages((prev: Message[]) => prev.filter(m => m.id !== "ai-processing"));

      if (aiResponse.success) {
        let aiContent = aiResponse.message
        let suggestedRecord: TransactionData | undefined = undefined

        // Â∞ùËØïËß£ÊûêAIËøîÂõûÁöÑJSONÊ†ºÂºè
        try {
          const jsonMatch = aiResponse.message.match(/```json\s*([\s\S]*?)\s*```/);
          if (jsonMatch) {
            const jsonData = JSON.parse(jsonMatch[1]);
            if (jsonData.type && jsonData.amount && jsonData.amount > 0) {
              // ÊâæÂà∞ÂØπÂ∫îÁöÑÂàÜÁ±ªID
              let category = null;
              
              // È¶ñÂÖàÂ∞ùËØïÊ†πÊçÆAIÊé®ËçêÁöÑÂàÜÁ±ªÂêçÁß∞ÂåπÈÖç
              if (jsonData.category) {
                category = currentBill?.categories.find(cat => 
                  cat.type === jsonData.type && 
                  cat.name.split(';').some(catName => 
                    catName.trim().includes(jsonData.category) || 
                    jsonData.category.includes(catName.trim())
                  )
                );
              }

              // Â¶ÇÊûúÊâæÂà∞ÂàÜÁ±ªÔºå‰ΩøÁî®ÂàÜÁ±ª‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂêçÁß∞‰Ωú‰∏∫item
              // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÂàÜÁ±ªÔºåitem‰∏∫Á©∫ÔºåËÆ©Áî®Êà∑ÊâãÂä®ÈÄâÊã©ÂàÜÁ±ª
              const item = category ? category.name.split(';')[0].trim() : "";

              suggestedRecord = {
                type: jsonData.type,
                date: new Date().toISOString().split('T')[0],
                item: item,
                amount: jsonData.amount,
                person: user?.user_metadata?.display_name || "Êàë",
                note: jsonData.description || "", // ÂÖ∑‰ΩìÊèèËø∞‰Ωú‰∏∫Â§áÊ≥®
                category_id: category?.original_id || category?.id || ""
              };

              aiContent = jsonData.message || `ÊàëÂ∏Æ‰Ω†Êï¥ÁêÜ‰∫Ü‰∏ÄÊù°${jsonData.type === "income" ? "Êî∂ÂÖ•" : "ÊîØÂá∫"}ËÆ∞ÂΩïÔºåËØ∑Á°ÆËÆ§ üëá`;
            }
          }
        } catch (error) {
          console.log('AIËøîÂõûÁöÑ‰∏çÊòØJSONÊ†ºÂºèÔºå‰ΩøÁî®ÂéüÂßãÂõûÂ§ç');
        }

        const aiMessage: Message = {
          id: (Date.now() + 1).toString(),
          type: "ai",
          content: aiContent,
          timestamp: new Date(),
          suggestedRecord: suggestedRecord,
        }

        setMessages((prev: Message[]) => [...prev, aiMessage])

        // ‰øùÂ≠òAIÂõûÂ§çÂà∞Êï∞ÊçÆÂ∫ì
        await saveAILog(currentBill.id, user.id, 'assistant', aiContent)

        if (suggestedRecord) {
          setSuggestedRecord(suggestedRecord)
          setShowConfirmModal(true)
        }
      } else {
        const errorMessage: Message = {
          id: (Date.now() + 1).toString(),
          type: "ai",
          content: aiResponse.message,
          timestamp: new Date(),
        }
        setMessages((prev: Message[]) => [...prev, errorMessage])
      }
    } catch (error) {
      // ÁßªÈô§Â§ÑÁêÜ‰∏≠Ê∂àÊÅØ
      setMessages((prev: Message[]) => prev.filter(m => m.id !== "ai-processing"));
      
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        type: "ai",
        content: "Êä±Ê≠âÔºåAIÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ",
        timestamp: new Date(),
      }
      setMessages((prev: Message[]) => [...prev, errorMessage])
    }

    setIsAISending(false)
  }

  const handleConfirmRecord = async () => {
    if (!suggestedRecord || !currentBill || isConfirming) return

    setIsConfirming(true)

    try {
    const result = await addTransaction(currentBill.id, suggestedRecord)
    
      if (!result.error && result.data) {
      setShowConfirmModal(false)
      setSuggestedRecord(null)
      
      // ÁßªÈô§ÊâÄÊúâÊ∂àÊÅØ‰∏≠ÁöÑsuggestedRecordÔºå‰ª•ÈöêËóè"Á°ÆËÆ§Ê∑ªÂä†ËÆ∞ÂΩï"ÊåâÈíÆ
      setMessages((prev: Message[]) => prev.map(msg => ({
        ...msg,
        suggestedRecord: undefined
      })))
      
      const confirmMessage: Message = {
        id: Date.now().toString(),
        type: "ai",
        content: "‚úÖ ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊ∑ªÂä†Âà∞Ë¥¶Êú¨‰∏≠ÔºÅ",
        timestamp: new Date(),
        linkedTransactionId: result.data.id, // ÂÖ≥ËÅî‰∫§ÊòìËÆ∞ÂΩïIDÔºåÁî®‰∫éÊòæÁ§∫ÁºñËæëÊåâÈíÆ
      }
      setMessages((prev: Message[]) => [...prev, confirmMessage])

        // ‰øùÂ≠òÁ°ÆËÆ§Ê∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ìÔºåÂÖ≥ËÅî‰∫§ÊòìËÆ∞ÂΩïID
        const { saveAILogWithTransaction } = await import('@/lib/ai')
        await saveAILogWithTransaction(currentBill.id, user!.id, 'assistant', "‚úÖ ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊ∑ªÂä†Âà∞Ë¥¶Êú¨‰∏≠ÔºÅ", result.data.id)
      }
    } catch (error) {
      console.error('Á°ÆËÆ§ËÆ∞ÂΩïÂ§±Ë¥•:', error)
    } finally {
      setIsConfirming(false)
    }
  }

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      handleSendMessage()
    }
  }

  const handleBillChange = (billId: string) => {
    setSelectedBillId(billId)
    setMessages([]) // Ê∏ÖÁ©∫ÂΩìÂâçÊ∂àÊÅØ
  }

  // Ëé∑Âèñ‰∫§ÊòìËÆ∞ÂΩïËØ¶ÊÉÖ
  const handleEditTransaction = async (transactionId: string) => {
    try {
      const { data, error } = await supabase
        .from('transactions')
        .select('*')
        .eq('id', transactionId)
        .single()

      if (error) {
        console.error('Ëé∑Âèñ‰∫§ÊòìËÆ∞ÂΩïÂ§±Ë¥•:', error)
        return
      }

      if (data) {
        setEditingTransaction(data)
        setShowEditModal(true)
      }
    } catch (error) {
      console.error('Ëé∑Âèñ‰∫§ÊòìËÆ∞ÂΩïÂ§±Ë¥•:', error)
    }
  }

  // Êõ¥Êñ∞‰∫§ÊòìËÆ∞ÂΩï
  const handleUpdateTransaction = async (transactionData: Partial<Transaction>) => {
    if (!editingTransaction) return

    try {
      const { error } = await supabase
        .from('transactions')
        .update(transactionData)
        .eq('id', editingTransaction.id)

      if (error) {
        console.error('Êõ¥Êñ∞‰∫§ÊòìËÆ∞ÂΩïÂ§±Ë¥•:', error)
        return
      }

      // Âà∑Êñ∞Ë¥¶Êú¨Êï∞ÊçÆ
      await fetchBills()
      
      setShowEditModal(false)
      setEditingTransaction(null)
    } catch (error) {
      console.error('Êõ¥Êñ∞‰∫§ÊòìËÆ∞ÂΩïÂ§±Ë¥•:', error)
    }
  }

  if (!user) {
    return null
  }

  return (
    <AppLayout>
      <div className="h-full flex flex-col">
        <header className="bg-white border-b border-gray-200 p-4 flex-shrink-0">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <Bot className="h-6 w-6 text-blue-600" />
              <div>
                <h1 className="text-lg font-semibold text-gray-900">AIÊô∫ËÉΩËÆ∞Ë¥¶</h1>
                <p className="text-sm text-gray-500">ÈÄâÊã©Ë¥¶Êú¨ÂºÄÂßãËÆ∞Ë¥¶</p>
              </div>
            </div>
            <div className="flex items-center space-x-3">
              <Select value={selectedBillId} onValueChange={handleBillChange}>
                <SelectTrigger className="w-48">
                  <SelectValue placeholder="ÈÄâÊã©Ë¥¶Êú¨" />
                </SelectTrigger>
                <SelectContent>
                  {bills.map((bill) => (
                    <SelectItem key={bill.id} value={bill.id}>
                      <div className="flex items-center space-x-2">
                        <span>{bill.name}</span>
                        <Badge variant="outline" className="text-xs">
                          {bill.permission === "owner" ? "Êã•ÊúâËÄÖ" : 
                           bill.permission === "edit_add" ? "ÁºñËæë" :
                           bill.permission === "add_only" ? "Ê∑ªÂä†" : "Êü•Áúã"}
                        </Badge>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              {currentBill && (
                <Badge className={`${
                  canEdit ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-700"
                }`}>
                  {canEdit ? "ÂèØÁºñËæë" : "Âè™ËØª"}
                </Badge>
              )}
            </div>
          </div>
        </header>

        <ScrollArea className="flex-1 p-4" ref={scrollAreaRef as any}>
          <div className="max-w-3xl mx-auto space-y-4 pb-4">
            {!currentBill && (
              <Card className="bg-yellow-50 border-yellow-200">
                <CardContent className="p-6 text-center">
                  <Bot className="h-12 w-12 text-yellow-600 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-yellow-900 mb-2">
                    ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ë¥¶Êú¨
                  </h3>
                  <p className="text-yellow-700">
                    Âú®‰∏äÊñπ‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¥¶Êú¨ÂºÄÂßãAIËÆ∞Ë¥¶
                  </p>
                </CardContent>
              </Card>
            )}

            {currentBill && isLoadingHistory && (
              <div className="text-center py-4">
                <p className="text-gray-500">Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤‰∏≠...</p>
              </div>
            )}

            {currentBill && !isLoadingHistory && messages.length === 0 && (
              <Card className="bg-blue-50 border-blue-200">
                <CardContent className="p-6 text-center">
                  <Bot className="h-12 w-12 text-blue-600 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-blue-900 mb-2">
                    üëã ‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑAIËÆ∞Ë¥¶Âä©Êâã
                  </h3>
                  <p className="text-blue-700 mb-4">
                    ÂëäËØâÊàë‰Ω†ÁöÑÊî∂ÊîØÊÉÖÂÜµÔºåÊàë‰ºöÂ∏Æ‰Ω†Âø´ÈÄüËÆ∞ÂΩïÂà∞„Äå{currentBill.name}„ÄçË¥¶Êú¨‰∏≠„ÄÇ‰æãÂ¶ÇÔºö
                  </p>
                  <div className="space-y-2 text-sm text-blue-600">
                    <p>‚Ä¢ "‰ªäÂ§©ÂçàÈ§êËä±‰∫Ü25ÂÖÉ"</p>
                    <p>‚Ä¢ "Êî∂Âà∞Â∑•ËµÑ8000ÂÖÉ"</p>
                    <p>‚Ä¢ "ÊâìËΩ¶ÂõûÂÆ∂Ëä±‰∫Ü15Âùó"</p>
                  </div>
                </CardContent>
              </Card>
            )}

            {messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.type === "user" ? "justify-end" : "justify-start"}`}
              >
                <div
                  className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                    message.type === "user"
                      ? "bg-blue-600 text-white"
                      : "bg-gray-100 text-gray-900"
                  }`}
                >
                  <div className="flex items-start space-x-2">
                    {message.type === "ai" && (
                      <Bot className="h-4 w-4 mt-0.5 flex-shrink-0 text-blue-600" />
                    )}
                    <div className="flex-1">
                      <p className="text-sm">{message.content}</p>
                      {message.suggestedRecord && (
                        <Card className="mt-2 bg-white border">
                          <CardContent className="p-3">
                            <div className="space-y-2 text-xs text-gray-700">
                              <div className="flex justify-between">
                                <span>Á±ªÂûã:</span>
                                <Badge variant={message.suggestedRecord.type === "income" ? "default" : "destructive"}>
                                  {message.suggestedRecord.type === "income" ? "Êî∂ÂÖ•" : "ÊîØÂá∫"}
                                </Badge>
                              </div>
                              <div className="flex justify-between">
                                <span>È°πÁõÆ:</span>
                                <span>{message.suggestedRecord.item}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>ÈáëÈ¢ù:</span>
                                <span className="font-semibold">¬•{message.suggestedRecord.amount}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>Êó•Êúü:</span>
                                <span>{message.suggestedRecord.date}</span>
                              </div>
                            </div>
                            <div className="mt-3 pt-2 border-t">
                              <Button
                                size="sm"
                                onClick={() => {
                                  setSuggestedRecord(message.suggestedRecord!)
                                  setShowConfirmModal(true)
                                }}
                                className="w-full text-xs"
                              >
                                Á°ÆËÆ§Ê∑ªÂä†ËÆ∞ÂΩï
                              </Button>
                            </div>
                          </CardContent>
                        </Card>
                      )}
                      {/* ‰∏∫ÂåÖÂê´linkedTransactionIdÁöÑÊ∂àÊÅØÊ∑ªÂä†ÁºñËæëÊåâÈíÆ */}
                      {message.type === "ai" && message.linkedTransactionId && canEdit && (
                        <div className="mt-2">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => handleEditTransaction(message.linkedTransactionId!)}
                            className="text-xs"
                          >
                            <Edit className="h-3 w-3 mr-1" />
                            ÁºñËæëËÆ∞ÂΩï
                          </Button>
                        </div>
                      )}
                      <p className="text-xs opacity-70 mt-1">
                        {message.timestamp.toLocaleTimeString()}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            ))}
            <div ref={messagesEndRef} />
          </div>
        </ScrollArea>

        <div className="bg-white border-t border-gray-200 p-4 flex-shrink-0">
          <div className="max-w-3xl mx-auto">
            <div className="flex space-x-2">
              <Input
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder={
                  !currentBill ? "ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êú¨" :
                  canEdit ? "ÊèèËø∞‰Ω†ÁöÑÊî∂ÊîØÊÉÖÂÜµ..." : "ÂΩìÂâçË¥¶Êú¨‰∏∫Âè™ËØªÊ®°Âºè"
                }
                disabled={!currentBill || !canEdit || isAISending}
                className="flex-1"
              />
              <Button
                onClick={handleSendMessage}
                disabled={!currentBill || !canEdit || !inputValue.trim() || isAISending}
                className="px-4"
              >
                {isAISending ? (
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" />
                ) : (
                  <Send className="h-4 w-4" />
                )}
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Á°ÆËÆ§ËÆ∞ÂΩïÂØπËØùÊ°Ü */}
      <Dialog open={showConfirmModal} onOpenChange={setShowConfirmModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Á°ÆËÆ§Ê∑ªÂä†ËÆ∞ÂΩï</DialogTitle>
          </DialogHeader>
          {suggestedRecord && (
            <div className="space-y-4">
                <div>
                  <label className="text-sm font-medium">Á±ªÂûã</label>
                <Select 
                  value={suggestedRecord.type} 
                  onValueChange={(value: "income" | "expense") => 
                    setSuggestedRecord({ ...suggestedRecord, type: value })
                  }
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="income">Êî∂ÂÖ•</SelectItem>
                    <SelectItem value="expense">ÊîØÂá∫</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <label className="text-sm font-medium">ÂàÜÁ±ª</label>
                <Select 
                  value={suggestedRecord.category_id ? `${suggestedRecord.category_id}_${suggestedRecord.item}` : ""} 
                  onValueChange={(value) => {
                    // valueÊ†ºÂºè‰∏∫ "originalId_categoryName"
                    const [originalId, categoryName] = value.split('_')
                    setSuggestedRecord({ 
                      ...suggestedRecord, 
                      category_id: originalId,
                      item: categoryName
                    })
                  }}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue placeholder="ÈÄâÊã©ÂàÜÁ±ª" />
                  </SelectTrigger>
                  <SelectContent>
                    {currentBill?.categories
                      .filter(cat => cat.type === suggestedRecord.type)
                      .flatMap((category) => {
                        // Â∞ÜÂàÜÂè∑ÂàÜÈöîÁöÑÂàÜÁ±ªÂêçÁß∞ÊãÜÂàÜÊàêÂçïÁã¨ÁöÑÈÄâÈ°π
                        const categoryNames = category.name.split(';').map(name => name.trim()).filter(name => name)
                        return categoryNames.map(name => ({
                          id: `${category.original_id || category.id}_${name}`,
                          name: name,
                          originalId: category.original_id || category.id
                        }))
                      })
                      .map((categoryOption) => (
                        <SelectItem key={categoryOption.id} value={categoryOption.id}>
                          {categoryOption.name}
                        </SelectItem>
                      ))}
                  </SelectContent>
                </Select>
                </div>
                <div>
                  <label className="text-sm font-medium">ÈáëÈ¢ù</label>
                <Input
                  type="number"
                  step="0.01"
                  value={suggestedRecord.amount}
                  onChange={(e) => setSuggestedRecord({ 
                    ...suggestedRecord, 
                    amount: parseFloat(e.target.value) || 0 
                  })}
                  className="mt-1"
                />
              </div>
              <div>
                <label className="text-sm font-medium">Êó•Êúü</label>
                <Input
                  type="date"
                  value={suggestedRecord.date}
                  onChange={(e) => setSuggestedRecord({ 
                    ...suggestedRecord, 
                    date: e.target.value 
                  })}
                  className="mt-1"
                />
              </div>
              <div>
                <label className="text-sm font-medium">Â§áÊ≥®</label>
                <Input
                  value={suggestedRecord.note}
                  onChange={(e) => setSuggestedRecord({ 
                    ...suggestedRecord, 
                    note: e.target.value 
                  })}
                  placeholder="Â§áÊ≥®‰ø°ÊÅØÔºàÂèØÈÄâÔºâ"
                  className="mt-1"
                />
              </div>
            </div>
          )}
          <DialogFooter>
            <Button 
              variant="outline" 
              onClick={() => setShowConfirmModal(false)}
              disabled={isConfirming}
            >
              ÂèñÊ∂à
            </Button>
            <Button 
              onClick={handleConfirmRecord}
              disabled={isConfirming}
            >
              {isConfirming ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" />
                  Ê∑ªÂä†‰∏≠...
                </>
              ) : (
                "Á°ÆËÆ§Ê∑ªÂä†"
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* ÁºñËæë‰∫§ÊòìËÆ∞ÂΩïÂØπËØùÊ°Ü */}
      <Dialog open={showEditModal} onOpenChange={setShowEditModal}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Edit className="mr-2 h-5 w-5 text-blue-600" />
              ÁºñËæë‰∫§ÊòìËÆ∞ÂΩï
            </DialogTitle>
          </DialogHeader>
          {editingTransaction && (
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium">ÈáëÈ¢ù</label>
                <Input
                  type="number"
                  step="0.01"
                  value={editingTransaction.amount}
                  onChange={(e) => setEditingTransaction({ ...editingTransaction, amount: parseFloat(e.target.value) || 0 })}
                  className="mt-1"
                />
                </div>
                <div>
                <label className="text-sm font-medium">ÂàÜÁ±ª</label>
                <Select 
                  value={editingTransaction.category_id && editingTransaction.item ? `${editingTransaction.category_id}_${editingTransaction.item}` : ""} 
                  onValueChange={(value) => {
                    // valueÊ†ºÂºè‰∏∫ "originalId_categoryName"
                    const [originalId, categoryName] = value.split('_')
                    setEditingTransaction({ 
                      ...editingTransaction, 
                      category_id: originalId,
                      item: categoryName
                    })
                  }}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue placeholder="ÈÄâÊã©ÂàÜÁ±ª" />
                  </SelectTrigger>
                  <SelectContent>
                    {currentBill?.categories
                      .filter(cat => cat.type === editingTransaction.type)
                      .flatMap((category) => {
                        // Â∞ÜÂàÜÂè∑ÂàÜÈöîÁöÑÂàÜÁ±ªÂêçÁß∞ÊãÜÂàÜÊàêÂçïÁã¨ÁöÑÈÄâÈ°π
                        const categoryNames = category.name.split(';').map(name => name.trim()).filter(name => name)
                        return categoryNames.map(name => ({
                          id: `${category.original_id || category.id}_${name}`,
                          name: name,
                          originalId: category.original_id || category.id
                        }))
                      })
                      .map((categoryOption) => (
                        <SelectItem key={categoryOption.id} value={categoryOption.id}>
                          {categoryOption.name}
                        </SelectItem>
                      ))}
                  </SelectContent>
                </Select>
                </div>
                <div>
                  <label className="text-sm font-medium">Êó•Êúü</label>
                <Input
                  type="date"
                  value={editingTransaction.date}
                  onChange={(e) => setEditingTransaction({ ...editingTransaction, date: e.target.value })}
                  className="mt-1"
                />
              </div>
              <div>
                <label className="text-sm font-medium">ÁªèÂäû‰∫∫</label>
                <Input
                  value={editingTransaction.person || ''}
                  readOnly
                  disabled
                  className="mt-1 bg-gray-50"
                />
                </div>
              <div>
                <label className="text-sm font-medium">Â§áÊ≥®</label>
                <Input
                  value={editingTransaction.note || ''}
                  onChange={(e) => setEditingTransaction({ ...editingTransaction, note: e.target.value })}
                  placeholder="Â§áÊ≥®‰ø°ÊÅØ"
                  className="mt-1"
                />
              </div>
            </div>
          )}
          <DialogFooter>
            <Button 
              variant="outline" 
              onClick={() => {
                setShowEditModal(false)
                setEditingTransaction(null)
              }}
            >
              ÂèñÊ∂à
            </Button>
            <Button 
              onClick={() => handleUpdateTransaction(editingTransaction!)}
              disabled={!editingTransaction}
            >
              ‰øùÂ≠ò‰øÆÊîπ
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </AppLayout>
  )
} 